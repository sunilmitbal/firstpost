name: terraform-pipeline

trigger: none

pool: sunilpool

jobs:
- job: terraform_all
  displayName: Terraform Init Plan Apply
  steps:

  # 1️⃣ Checkout code
  - checkout: self
    clean: true

  # 2️⃣ Install Terraform
  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: 'latest'

  # 3️⃣ Azure Login (Service Connection)
  - task: AzureCLI@2
    displayName: Azure Login
    inputs:
      azureSubscription: 'FinalSVC'
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: |
        az account show

  # 4️⃣ Terraform Init
  - task: PowerShell@2
    displayName: Terraform Init
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)
      script: |
        terraform version

        terraform init `
          -upgrade `
          -backend-config="resource_group_name=Rg_rohit" `
          -backend-config="storage_account_name=stgrgrohit" `
          -backend-config="container_name=stgrgrohitctr" `
          -backend-config="key=kuchhbhi.tfstate" `
          -backend-config="subscription_id=4f20f78d-e549-4182-af3e-0437bdcacf18" `
          -backend-config="use_azuread_auth=true"

  # 5️⃣ Terraform Plan
  - task: PowerShell@2
    displayName: Terraform Plan
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)
      script: |
        terraform plan

  # 6️⃣ Terraform Apply
  - task: PowerShell@2
    displayName: Terraform Apply
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)
      script: |
        terraform apply -auto-approve
