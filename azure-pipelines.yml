name: terraform-pipeline

trigger: none

pool: sunilpool

jobs:
- job: terraform_all
  displayName: Terraform Init | Plan | Apply
  steps:

  # 1Ô∏è‚É£ Checkout code
  - checkout: self
    clean: true

  # 2Ô∏è‚É£ Install Terraform
  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: 'latest'

  # 3Ô∏è‚É£ Azure Login (Service Connection)
  - task: AzureCLI@2
    displayName: Azure Login
    inputs:
      azureSubscription: 'FinalSVC'
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: |
        az account show

  # 4Ô∏è‚É£ Terraform Init (Remote Backend)
  - task: PowerShell@2
    displayName: Terraform Init
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)
      script: |
        terraform version

        terraform init `
          -upgrade `
          -backend-config="resource_group_name=Rg_rohit" `
          -backend-config="storage_account_name=stgrgrohit" `
          -backend-config="container_name=stgrgrohitctr" `
          -backend-config="key=terraform.tfstate" `
          -backend-config="subscription_id=4f20f78d-e549-4182-af3e-0437bdcacf18" `
          -backend-config="use_azuread_auth=true"

  # =====================================================
  # ‚ö†Ô∏è ONE-TIME STEPS (RUN ONLY ON FIRST PIPELINE RUN)
  # =====================================================

  # 5Ô∏è‚É£ Import Resource Group (RUN ONCE)
  - task: PowerShell@2
    displayName: Terraform Import Resource Group (Run once)
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)
      script: |
        terraform import azurerm_resource_group.sonil `
        /subscriptions/4f20f78d-e549-4182-af3e-0437bdcacf18/resourceGroups/Rg_rohit

  # 6Ô∏è‚É£ Import Storage Account (RUN ONCE)
  - task: PowerShell@2
    displayName: Terraform Import Storage Account (Run once)
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)
      script: |
        terraform import azurerm_storage_account.tfstate `
        /subscriptions/4f20f78d-e549-4182-af3e-0437bdcacf18/resourceGroups/Rg_rohit/providers/Microsoft.Storage/storageAccounts/stgrgrohit

  # =====================================================
  # üîÅ NORMAL TERRAFORM FLOW
  # =====================================================

  #
